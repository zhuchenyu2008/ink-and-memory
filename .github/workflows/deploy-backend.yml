name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

env:
  IMAGE: ghcr.io/shuxueshuxue/ink-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t $IMAGE:${GITHUB_SHA} \
            -t $IMAGE:latest \
            --push \
            backend

      - name: Export image tag
        id: meta
        run: echo "image_tag=${IMAGE}:${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to server over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 101.201.227.31
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
            cd /root/ink-and-memory/backend
            mkdir -p /root/ink-and-memory/backend/data
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u shuxueshuxue --password-stdin >/dev/null
            docker pull "${IMAGE_TAG}"
            docker rm -f ink-backend || true
            docker run -d --name ink-backend --restart unless-stopped \
              -p 127.0.0.1:8765:8765 \
              -v /root/ink-and-memory/backend/data:/app/data \
              -e BACKEND_VERSION=${IMAGE_TAG} \
              ${IMAGE_TAG}
            tmux kill-session -t ink-and-memory-docker || true
            tmux new -d -s ink-and-memory-docker "docker logs -f --tail 200 ink-backend"
